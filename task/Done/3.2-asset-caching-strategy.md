# Task 3.2: Asset Caching Strategy

**Epic**: Epic 3: Offline-First Architecture

## Task Details

- [x] Create cache manifest for static assets
- [x] Implement precaching for critical resources:
- [x] Implement **complete image library caching**:
- [x] Implement runtime caching for user-added pictures
- [x] Set cache expiration policies

---

## Completion Summary

**Completed on**: 2026-02-19

### Implementation Details

1. **Created `public/assets/pictures/` directory**: Picture library location for built-in images, included in Workbox precache glob patterns (`**/*.{png,jpg,jpeg,svg,...}`), so all images are automatically precached on first launch.

2. **Cache expiration policies** (`apps/pictho-app/public/service-worker.js`):
   - `MAX_CACHE_AGE_MS`: 30 days — cached responses older than 30 days are refetched from the network
   - `MAX_IMAGE_CACHE_ENTRIES`: 200 — built-in picture library cache is capped at 200 entries
   - `MAX_USER_PICTURES_CACHE_ENTRIES`: 50 — user-added pictures cache is capped at 50 entries
   - `isCacheExpired()`: Helper that checks the `date` header of a cached response against `MAX_CACHE_AGE_MS`
   - `enforceCacheLimit()`: Async helper that evicts the oldest cache entries when the limit is exceeded

3. **Dedicated user-added pictures cache** (`pictoh-user-pictures-v1`):
   - Separate from the built-in images cache (`pictoh-images-v1`)
   - Stricter entry limit (50 vs 200) to keep user data manageable
   - Routes requests for `/user-pictures/*` paths to this cache

4. **Fetch routing** — distinguishes user pictures from built-in pictures:
   - `/user-pictures/*` → `USER_PICTURES_CACHE` with 50-entry limit
   - Image extensions → `IMAGES_CACHE` with 200-entry limit
   - JS/CSS/fonts → `ASSETS_CACHE`
   - App shell → `APP_SHELL_CACHE`
   - Everything else → `CACHE_NAME`

5. **Message handlers** (`CACHE_URLS` + new `CACHE_USER_PICTURE`):
   - `CACHE_URLS`: bulk preloading of picture library URLs (used on first launch in Task 3.4)
   - `CACHE_USER_PICTURE`: caches a single user-added picture immediately, enforces limit

6. **`serviceWorkerRegistration.ts`** — two new exported utility functions:
   - `cachePictureLibrary(urls: string[])`: sends `CACHE_URLS` to precache the full picture library
   - `cacheUserPicture(url: string)`: sends `CACHE_USER_PICTURE` for immediate caching of a user picture

7. **Vite config** — added explicit `globDirectory` for Workbox `injectManifest` to ensure the built dist folder is scanned for all assets including pictures.

### Cache Structure

| Cache Name                | Contents                        | Max Entries | Max Age |
| ------------------------- | ------------------------------- | ----------- | ------- |
| `pictoh-shell-v1`         | App shell (HTML, manifest, ico) | unlimited   | none    |
| `pictoh-assets-v1`        | JS, CSS, fonts                  | unlimited   | 30 days |
| `pictoh-images-v1`        | Built-in picture library        | 200         | 30 days |
| `pictoh-user-pictures-v1` | User-added pictures             | 50          | 30 days |
| `pictoh-v1`               | Workbox precache manifest       | unlimited   | none    |

### Testing

- ✅ Build passes successfully (`npx nx build pictho-app`)
- ✅ Linting passes (`npm run lint`)
- ✅ Formatting passes (`npm run format:check`)
- ✅ Service worker compiled and precache manifest injected (7 entries, 224 KiB)

### Files Created

- `apps/pictho-app/public/assets/pictures/.gitkeep` — picture library directory

### Files Modified

- `apps/pictho-app/public/service-worker.js` — cache expiration, dedicated user pictures cache, `isCacheExpired()`, `enforceCacheLimit()`, `CACHE_USER_PICTURE` handler
- `apps/pictho-app/src/serviceWorkerRegistration.ts` — `cachePictureLibrary()` and `cacheUserPicture()` helpers
- `apps/pictho-app/vite.config.mts` — explicit `globDirectory` for Workbox precache
