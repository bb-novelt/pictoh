# Task 3.3: Web Worker for Background Tasks

**Epic**: Epic 3: Offline-First Architecture

## Task Details

- [x] Create Web Worker for background downloads
- [x] Implement picture library download logic
- [x] Implement TTS model download logic
- [x] Add progress tracking for downloads
- [x] Implement message passing between main thread and worker

## Completion Summary

**Date Completed**: 2026-02-19

**Work Done**:

- Created `apps/pictho-app/src/workers/downloadWorkerMessages.ts` with shared TypeScript types for all worker messages (`WorkerIncomingMessage`, `WorkerOutgoingMessage`, `DownloadProgress`, `DownloadPhase`)
- Created `apps/pictho-app/src/workers/downloadWorker.ts` implementing the Web Worker:
  - Listens for `START_DOWNLOADS` message with `pictureUrls` and `ttsModelUrls` arrays
  - Downloads each URL sequentially using `fetch()`; the service worker intercepts and caches each response automatically via its cache-first strategy
  - Reports `PROGRESS` messages after each successful file download (phase, downloaded count, total, percentage)
  - Reports `PHASE_COMPLETE` after completing each phase (`pictures` then `tts`)
  - Reports `ALL_COMPLETE` when both phases finish
  - Reports `ERROR` per-file without aborting remaining downloads
  - Supports `CANCEL` message to abort in-progress downloads
- Enabled Vite worker plugin support in `vite.config.mts` (uncommented `worker.plugins` section)

**Notes**:

- The worker file uses `/// <reference lib="webworker" />` for correct TypeScript types without conflicting with DOM types
- TTS model download logic is implemented as infrastructure; the actual model URLs will be supplied by Task 5.3 (TTS Integration)
- The main thread imports the worker via Vite's `?worker` syntax: `import DownloadWorker from './workers/downloadWorker?worker'`
- Per-file fetch errors are reported individually and do not stop the overall download process
