# Task 5.3: Text-to-Speech Integration

**Epic**: Epic 5: Square Interaction & TTS Integration

## Task Details

- [x] Research and select local TTS library
- [x] Create `TTSService` class/module
- [x] Implement `speak(text: string)` method
- [x] Download and cache TTS model on first launch
- [x] Add to Web Worker download queue
- [x] Handle TTS errors gracefully
- [x] Add TTS state management (speaking, idle, error)

## File Location

Place all files for this task inside `src/tts/` (feature folder for TTS).
Example: `src/tts/ttsService.ts`

## Completion Summary

**Date Completed**: 2026-02-23

**Work Done**:

- Replaced the no-op stub in `src/tts/ttsService.ts` with a full
  Web Speech API implementation:
  - `ttsState` — Valtio proxy with `status: 'idle' | 'speaking' | 'error'`
    and `errorMessage: string | null`. Reactive; components can subscribe.
  - `pickFrenchFemaleVoice(voices)` — selects the best French female voice
    from the browser's voice list (exported for testing).
  - `initTts()` — pre-selects the French female voice on app start.
    Registers a `voiceschanged` listener so the voice is updated when
    Chromium loads its voice list asynchronously.
  - `speak(text)` — cancels any ongoing speech, creates an
    `SpeechSynthesisUtterance` with `lang='fr-FR'` and the pre-selected
    voice, then fires it. Updates `ttsState` via `onstart` / `onend` /
    `onerror` callbacks. Gracefully no-ops when the API is unavailable.
- Updated `src/tts/index.ts` to export `ttsState`, `initTts`, and the
  `TtsStatus` type alongside the existing `speak` export.
- Updated `src/app/app.tsx` to call `initTts()` in a `useEffect` that
  runs once on mount, so the French voice is pre-selected before the
  first touch.
- Updated the comment on `getTtsModelUrls()` in
  `src/firstLaunch/firstLaunchUtils.ts` to explain that no model file
  needs to be downloaded (Web Speech API uses the device's local engine).
- Created `src/tts/ttsService.test.ts` with 19 tests covering:
  - `pickFrenchFemaleVoice`: null for empty/non-French list; first French
    voice fallback; female-name heuristics (Marie, Amélie, siwis); fr-CA.
  - `speak`: no-op on empty text; cancels existing speech; calls
    `speechSynthesis.speak`; sets `lang='fr-FR'`; state transitions
    (idle → speaking → idle, idle → error); safe when API unavailable.
  - `initTts`: safe when API unavailable; calls `getVoices`; registers
    `voiceschanged` listener; updates voice selection when listener fires.

**Notes**:

- **TTS library choice — Web Speech API**: The plan listed Web Speech API,
  Piper TTS, and Coqui TTS as candidate options. Web Speech API was
  selected because:
  - The target platform is a tablet (Android/iOS both ship built-in
    offline TTS voices, including high-quality French female voices).
  - No model file needs to be downloaded, so first-launch download time
    is minimised and there is no risk of model-size regression.
  - Zero additional dependencies — no WASM or large binary assets.
  - The plan explicitly lists Web Speech API as a valid option and names
    it as the fallback if a downloadable model proves too large.
- **Download queue**: `getTtsModelUrls()` returns `[]` because the Web
  Speech API needs no model files. The download worker already handles
  an empty list correctly (sends `PHASE_COMPLETE` immediately).
- **"Preloaded" voice**: `initTts()` is called once in `App`'s `useEffect`
  so the voice selection is ready before the user first touches a square.
