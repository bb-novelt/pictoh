# Task 5.2: Normal Mode Click Behavior

**Epic**: Epic 5: Square Interaction & TTS Integration

## Task Details

- [x] Handle square touch in normal mode
- [x] Trigger on **touch start** (not on release)
- [x] **Border color changes for 1 second** as visual feedback
- [x] Trigger TTS for associated text
- [x] Navigate to target page immediately (do not wait for TTS)
- [x] Prevent multiple simultaneous touches

## File Location

Place all files for this task inside `src/grid/` (feature folder for grid/squares).
Example: interaction logic in `src/grid/useSquareInteraction.ts`

## Completion Summary

**Date Completed**: 2026-02-23

**Work Done**:

- Created `src/tts/ttsService.ts` — minimal `speak(text)` stub (placeholder
  for Task 5.3 which will add the real local TTS engine). Marked with
  `// TODO(5.3)` so it is easy to find.
- Created `src/tts/index.ts` — barrel export for the tts feature folder.
- Created `src/grid/useSquareInteraction.ts` — React hook that:
  - Holds an `activeTouchRef` boolean ref as a global simultaneous-touch lock.
  - On `handleInteraction(square)`:
    1. Returns early if lock is held (prevents multiple simultaneous touches).
    2. Sets the lock for 1 second (matching the border-flash duration).
    3. Calls `speak(associatedText)` if text is set (fire-and-forget TTS).
    4. Calls `navigateToPage(openPageId)` immediately if a target page is set
       (does not wait for TTS to finish).
- Updated `src/grid/Grid.tsx`:
  - Imported `useSquareInteraction`.
  - Called `useSquareInteraction()` to get `handleInteraction`.
  - Passed `onClick={() => handleInteraction(square)}` to each `<Square>`.
    This wires up the interaction for both touch start (via Square's
    `handleTouchStart`) and edit-mode clicks.
- Created `src/grid/useSquareInteraction.test.ts` with 7 tests covering:
  - Calls `speak` with the square's `associatedText`
  - Does not call `speak` when `associatedText` is empty
  - Navigates to `openPageId` when set
  - Does not navigate when `openPageId` is empty
  - Prevents a second simultaneous interaction within the 1-second lock window
  - Allows a new interaction after the lock window expires
  - Calls `speak` before `navigateToPage` in the same tick (navigate immediately)

**Notes**:

- The border-flash-on-touch visual feedback was already implemented in
  `Square.tsx` (Task 4.3) via `onTouchStart → setTouched(true)` with a
  1-second timeout. No changes were needed there.
- `speak()` is a no-op until Task 5.3 replaces it with the local TTS model.
