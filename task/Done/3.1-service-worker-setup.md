# Task 3.1: Service Worker Setup

**Epic**: Epic 3: Offline-First Architecture

## Task Details

- [x] Create custom service worker file
- [x] Configure service worker registration in main app
- [x] Implement cache-first strategy for app shell
- [x] Implement network-first fallback to cache for assets
- [x] Handle service worker lifecycle events

---

## Completion Summary

**Completed on**: 2026-02-17

### Implementation Details

1. **Custom Service Worker** (`apps/pictho-app/public/service-worker.js`):
   - Implemented custom service worker with Workbox integration
   - Uses `injectManifest` strategy for flexibility and control
   - Workbox automatically injects precache manifest of all build assets
   - Implements cache-first strategy for all resources (100% offline app):
     - **Cache-first** for app shell (HTML, CSS, JS, icons)
     - **Cache-first** for images with intelligent caching
     - **Cache-first** for all other resources
   - Lifecycle event handlers:
     - `install`: Caches app shell and precache manifest
     - `activate`: Cleans up old caches
     - `fetch`: Routes all requests to cache-first strategy for offline-first operation
   - Message handler for runtime cache preloading (future use)

2. **Service Worker Registration** (`apps/pictho-app/src/serviceWorkerRegistration.ts`):
   - TypeScript module for managing service worker lifecycle
   - Handles registration with callbacks for success, update, and offline ready
   - Different behavior for localhost vs production
   - Automatic update checks every hour
   - Utility functions: `register()`, `unregister()`, `skipWaiting()`, `cacheUrls()`

3. **Main App Integration** (`apps/pictho-app/src/main.tsx`):
   - Registers service worker on app startup
   - Configured with lifecycle callbacks for future UI notifications

4. **Vite Configuration** (`apps/pictho-app/vite.config.mts`):
   - Updated to use `injectManifest` strategy
   - Configured to build custom service worker with Workbox
   - Glob patterns for asset precaching
   - Dev mode enabled for testing

### Cache Structure

The service worker uses four separate caches:

- `pictoh-shell-v1`: App shell (HTML, manifest, favicon)
- `pictoh-assets-v1`: Static assets (JS, CSS, fonts)
- `pictoh-images-v1`: Images and pictures
- `pictoh-v1`: Workbox precache manifest

### Testing

- ✅ Build passes successfully
- ✅ Linting passes (no errors)
- ✅ Service worker file is generated and served correctly
- ✅ Precache manifest is properly injected with all build artifacts
- ✅ Service worker registration code is included in bundle
- ✅ Production preview server serves service worker correctly

### Files Created

- `apps/pictho-app/public/service-worker.js` - Custom service worker
- `apps/pictho-app/src/serviceWorkerRegistration.ts` - Registration module

### Files Modified

- `apps/pictho-app/src/main.tsx` - Added service worker registration
- `apps/pictho-app/vite.config.mts` - Configured PWA plugin for injectManifest

### Next Steps

The service worker is now ready for:

- Task 3.2: Asset caching strategy (will use the cache infrastructure)
- Task 3.3: Web worker for background tasks
- Task 3.4: First launch experience (will use service worker for progress tracking)
- Task 8.x: Picture caching (will use `cacheUrls()` utility)

### Updates

**2026-02-17**: Fixed cache strategy to be 100% offline

- Changed from network-first to cache-first for all resources to align with PROJECT-OVERVIEW.md requirement that "the app must work 100% offline after the first launch"
- Removed unused `networkFirst()` function
- All fetch requests now use cache-first strategy exclusively
