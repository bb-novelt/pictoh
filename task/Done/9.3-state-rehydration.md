# Task 9.3: State Rehydration

**Epic**: Epic 9: Persistence & Storage

## Task Details

- [x] Load config from localStorage on app start
- [x] Restore pages (by `pageId`), squares, picture tracking
- [x] Restore current page (`currentPageId`) and edit mode state
- [x] Handle missing/corrupted data
- [x] Initialize with defaults if no saved data
- [x] Restore user-added pictures

## File Location

Place all files for this task inside `src/storage/` (feature folder for persistence).

## Completion Summary

**Files created:**

- `apps/pictho-app/src/storage/rehydrateStore.ts` – `rehydrateStore()` function that loads the persisted `AppConfig` from localStorage via `storageService.loadAppConfig()`, validates its top-level structure, sanitises the `currentPageId` (resets to `homePageId` if the page no longer exists), then applies the result to the Valtio store in place.
- `apps/pictho-app/src/storage/rehydrateStore.test.ts` – 14 tests covering no-data, invalid/corrupted data, successful rehydration (all fields including user-added pictures and `lastUsedTime` tracking), and sanitisation.

**Files modified:**

- `apps/pictho-app/src/main.tsx` – calls `rehydrateStore()` once before `root.render()` so the store is populated from localStorage before the first React render, avoiding a flash of default content.

**Behaviour:**

- On first launch (nothing in localStorage) the store keeps its default values (home page with sample squares).
- On subsequent launches the full state (pages, squares, pictures, `currentPageId`, `isEditMode`) is restored.
- User-added pictures are embedded inside the squares' `selectedPicture` field and are therefore restored automatically alongside the rest of the config.
- Corrupted or structurally invalid data is silently discarded and the app falls back to defaults.
