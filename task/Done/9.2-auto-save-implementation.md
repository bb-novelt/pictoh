# Task 9.2: Auto-Save Implementation

**Epic**: Epic 9: Persistence & Storage

## Task Details

- [x] Subscribe to Valtio state changes
- [x] Debounce save operations (e.g., 500ms)
- [x] Save to localStorage on every change
- [x] Handle save errors gracefully
- [x] Show **discrete save indicator** when saving:
  - Brief, non-intrusive visual feedback
  - Small icon or text (e.g., "Saved" or checkmark)
  - Fades out after 1-2 seconds

## File Location

Place all files for this task inside `src/storage/` (feature folder for persistence).
The save indicator component also belongs in `src/storage/`.
Example: `src/storage/autoSave.ts`, `src/storage/SaveIndicator.tsx`

## Completion Summary

**Date Completed**: 2026-02-25

**Work Done**:

- Created `src/storage/autoSave.ts`:
  - `initAutoSave()` — subscribes to the Valtio store via `subscribe()`, debounces writes by 500 ms, and calls `storageService.saveAppConfig()` after each debounce. Returns a cleanup function that cancels the subscription and any pending timer.
  - `onSave(listener)` — lets consumers (e.g. `SaveIndicator`) register callbacks that fire after every successful save.
- Created `src/storage/SaveIndicator.tsx`:
  - MUI `Chip` fixed in the bottom-left corner showing "Sauvegardé" with a checkmark icon.
  - Appears on each save and disappears automatically after 1.5 seconds.
  - Styled consistently with the existing `OfflineIndicator`.
- Updated `src/app/app.tsx`:
  - `initAutoSave()` wired up in a `useEffect` (cleanup on unmount).
  - `<SaveIndicator />` added next to `<OfflineIndicator />`.
- Added `src/storage/autoSave.test.ts` with 9 tests covering debounce, cleanup, listeners, and rapid-change coalescing.

**Notes**:

- `storageService.saveAppConfig()` already handles `QuotaExceededError` internally, so `autoSave.ts` does not wrap the call in a try/catch.
- The debounce timer is local to each `initAutoSave()` call to keep the module stateless and testable.
